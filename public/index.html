<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lur’e Observer – Wasm Backend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="rho_wasm.js"></script>
  <style>
    :root{ --bg:#0b0d12; --panel:#11141b; --muted:#a7b0c0; --text:#e9eef6; --accent:#7c9cff; --ok:#1cc88a; --warn:#f59e0b; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .grid{display:grid;grid-template-columns:1fr 2fr;gap:16px}
    .card{background:var(--panel);border:1px solid #1a2232;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .card .hd{padding:14px 16px;border-bottom:1px solid #1a2232;font-weight:600}
    .card .bd{padding:16px}
    .row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .row.space{justify-content:space-between}
    .muted{color:var(--muted)}
    .btn{border:1px solid #2a3349;background:#182134;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#1c2840}
    .btn.secondary{background:#0f1726}
    .number{width:90px;background:#0f1726;border:1px solid #28314a;color:var(--text);padding:6px 8px;border-radius:8px}
    .toggle{width:38px;height:24px;border-radius:999px;background:#1b263b;border:1px solid #273352;position:relative;cursor:pointer}
    .toggle .dot{position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#6b7386;transition:all .15s}
    .toggle.on{background:#173a26;border-color:#234f3b}
    .toggle.on .dot{left:18px;background:#1cc88a}
    .knob{margin:12px 0}
    .knob label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:4px}
    .slider{width:100%}
    canvas{background:#0a0f1c;border-radius:12px;border:1px solid #1a2232}
    .legend{display:flex;gap:8px;margin-top:8px}
    .dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const {useEffect,useMemo,useRef,useState,useCallback} = React;
    const clamp = (x,l,h)=>Math.max(l,Math.min(h,x));

    function Toggle({c,fn}) {
      return <div className={"toggle"+(c?" on":"")} onClick={()=>fn(!c)}><div className="dot"></div></div>;
    }

    function Knob({l,v,fn,min,max,step=0.1}) {
      return (
        <div className="knob">
          <label><span>{l}</span><input className="number" type="number" step={step} value={v} onChange={e=>fn(clamp(Number(e.target.value),min,max))}/></label>
          <input className="slider" type="range" min={min} max={max} step={step} value={v} onChange={e=>fn(Number(e.target.value))}/>
        </div>
      );
    }

    function useChart(ref) {
      const chart = useRef(null);
      useEffect(()=>{
        chart.current = new Chart(ref.current.getContext('2d'), {
          type:'line',
          data:{ datasets:[
            {label:'e', data:[], borderColor:'#1cc88a', borderWidth:2, pointRadius:0},
            {label:'p', data:[], borderColor:'#7c9cff', borderWidth:1, pointRadius:0},
            {label:'hp', data:[], borderColor:'#f59e0b', borderWidth:1, pointRadius:0}
          ]},
          options:{ animation:false, parsing:false, scales:{ x:{type:'linear', display:false} }, plugins:{legend:{display:false}} }
        });
        return ()=>chart.current.destroy();
      },[]);
      return {
        push: (t,e,p,hp) => {
          const c=chart.current; if(!c)return;
          const ds=c.data.datasets;
          ds[0].data.push({x:t,y:e}); ds[1].data.push({x:t,y:p}); ds[2].data.push({x:t,y:hp});
          if(ds[0].data.length>1000) ds.forEach(d=>d.data.shift());
          c.update('none');
        },
        reset: () => chart.current?.data.datasets.forEach(d=>d.data=[])
      };
    }

    function App(){
      const [wasm, setWasm] = useState(null);
      const filter = useRef(null);
      
      const [w, setW] = useState(2.0);
      const [A, setA] = useState(1.0);
      const [phi, setPhi] = useState(0.0);
      
      const [k1, setK1] = useState(1.0);
      const [k2, setK2] = useState(1.0);
      const [k3, setK3] = useState(1.0);
      const [alpha, setAlpha] = useState(1.0);
      
      const [run, setRun] = useState(false);
      const cvs = useRef(null);
      const chart = useChart(cvs);
      
      const sim = useRef({t:0, q:0, p:0});

      useEffect(() => {
        createRhoModule().then(m => setWasm(m));
      }, []);

      const reset = useCallback(() => {
        if(!wasm) return;
        if(filter.current) filter.current.delete();
        filter.current = new wasm.RhoFilter(0.01, 1, alpha, k1, k2, k3);
        sim.current = { t:0, q:A*Math.sin(phi), p:A*w*Math.cos(phi) };
        chart.reset();
      }, [wasm, alpha, k1, k2, k3, A, w, phi]);

      useEffect(() => {
        let raf;
        const dt = 0.01;
        const loop = () => {
          if(run && filter.current && wasm) {
            const s = sim.current;
            // Plant (Euler)
            s.q += s.p * dt;
            s.p += (-w*w * s.q) * dt;
            s.t += dt;

            // Wasm Filter
            const vin = new wasm.VectorDouble();
            vin.push_back(s.q);
            const vout = filter.current.update(vin);
            const hp = vout.get(vout.size()-1); 
            
            // Memory cleanup is mandatory
            vin.delete();
            vout.delete();

            chart.push(s.t, s.p - hp, s.p, hp);
          }
          raf = requestAnimationFrame(loop);
        };
        raf = requestAnimationFrame(loop);
        return () => cancelAnimationFrame(raf);
      }, [run, w, wasm]);

      return (
        <div className="wrap">
          <h1>Lur’e Observer (Wasm)</h1>
          <div className="grid">
            <div className="card">
              <div className="hd">Controls {!wasm && "(Loading Wasm...)"}</div>
              <div className="bd">
                <div className="row space">
                  <div className="row"><span>Run</span><Toggle c={run} fn={setRun}/></div>
                  <button className="btn secondary" onClick={reset}>Reset / Apply Gains</button>
                </div>
                
                <div className="knob-group" style={{marginTop:20}}>
                  <div className="hd" style={{paddingLeft:0}}>Plant</div>
                  <Knob l="ω" v={w} fn={setW} min={0.1} max={10}/>
                  <Knob l="Amp" v={A} fn={setA} min={0.1} max={5}/>
                  <Knob l="Phi" v={phi} fn={setPhi} min={-3.14} max={3.14}/>
                </div>

                <div className="knob-group" style={{marginTop:20}}>
                  <div className="hd" style={{paddingLeft:0}}>Observer (C++)</div>
                  <Knob l="α" v={alpha} fn={setAlpha} min={0} max={20}/>
                  <Knob l="k1" v={k1} fn={setK1} min={0} max={20}/>
                  <Knob l="k2" v={k2} fn={setK2} min={0} max={20}/>
                  <Knob l="k3" v={k3} fn={setK3} min={0} max={20}/>
                </div>
              </div>
            </div>

            <div className="card">
              <div className="hd">Estimation Error (e = p - p̂)</div>
              <div className="bd">
                <canvas ref={cvs} height="300"></canvas>
                <div className="legend">
                  <div><span className="dot" style={{background:'#1cc88a'}}></span>e</div>
                  <div><span className="dot" style={{background:'#7c9cff'}}></span>p</div>
                  <div><span className="dot" style={{background:'#f59e0b'}}></span>hp</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>